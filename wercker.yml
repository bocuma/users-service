box: haskell:7.10
dev:
  steps:
    - script:
        cwd: server/
        name: cabal-update
        code: |
          cabal update
    - script:
        cwd: server/
        name: cabal-install
        code: |
          cabal install --enable-tests
    - internal/watch:
        cwd: server/
        code: |
          cabal test
          cabal run
        reload: true
build:
  steps:
    - script:
        cwd: server/
        name: update
        code: |
          cabal update
    - script:
        cwd: server/
        name: install
        code: |
          cabal install --enable-tests
    - script:
        cwd: server/
        name: test
        code: |
          cabal test
    - script:
        name: copy artifact
        code: |
          cp task.json server/dist/build/users-service/users-service "$WERCKER_OUTPUT_DIR"
          ls "$WERCKER_OUTPUT_DIR"
deploy:
  box: python:2.7-slim
  steps:
    - internal/docker-push:
      username: $DOCKER_USER
      password: $DOCKER_PASS
      repository: cammellos/users-service
      cmd: "./pipeline/source/users-service"
      ports: 3000
      registry: https://registry.hub.docker.com
    - script:
      name: copy
      code: mkdir /app && cp task.json /app/
    - tonnu/aws-ecs:
      key: $AWS_ACCESS_KEY
      secret: $AWS_SECRET_KEY
      region: eu-west-1
      cluster-name: dequebuzz
      service-name: users-service
      task-definition-name: users-service
      task-definition-file: /app/task.json
      minimum-running-tasks: 1
